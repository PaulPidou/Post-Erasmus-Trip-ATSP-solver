<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
 
 
 	<!-- distributed -->
 	<script src="http://yourserver.com:8888/socket.io/socket.io.js"></script>
 	<script src="q.js"></script>
 	<script src="client.js"></script>
 
	<title>Benchmark distributed client system</title>
	
	
</head>
 
<body>
	
	<h3>Calculation</h3>
	
	Select how many times the action should be performed:<br/>
 	<input type="number" id="counts" placeholder="# of execution"/><br/><br/>
 	Select Action:<br/>
 	<a href="javascript:;" onclick="startCommunicationJobBenchmark();">Measure from job creation to finish</a>&nbsp;/&nbsp;
 	<a href="javascript:;" onclick="startCommunicationBenchmark();">Measure communication from slave to master (when sharing data)</a><br/><br/>
 	Note: At least 1 other client must be visiting this page at the same time to act as the second client.
 
 	<h3>Results</h3>
 	table contains milliseconds of measurement to finish the performed task:<br/>
 	
 	<table id="results">
 	</table>
 	
 	
 	<br/>
 	<hr/>
 	<h3>Distributed Log</h3>
 	<div id="log_distributed"></div>
 	
 	 	
 	<script>
 	
 	
 		var start, count,max;
 		
		var distributedSystemInit = function(_this){
 			if( typeof distributedSystem === 'undefined' ){
 				$('#results').after('distributedSystem not installed');
 					$('#results').remove();
 				
 				return;
 			}
 			distributedSystem.addJob( 'roundtrip',{
 				initMaster: function(ds){
 					ds.logger = function(txt,replace){
 						if( replace ){
 							document.getElementById('log_distributed').innerHTML=txt+'<br/>';
 						} else {
 							document.getElementById('log_distributed').innerHTML=txt+'<br/>'+document.getElementById('log_distributed').innerHTML;
 						}
 					};
 					//ds.logger('');
 				},
 				initSlave: function(ds){
 					ds.logger = function(txt,replace){
 						if( replace ){
 							document.getElementById('log_distributed').innerHTML=txt+'<br/>';
 						} else {
 							document.getElementById('log_distributed').innerHTML+=txt+'<br/>';
 						}
 					};
 					ds.logger('<br/>new job');
 				},
 				unavailable: function(ds){
 					$('#results').after('distributed system not available');
 					$('#results').remove();
 				},
 				
 				start: function(ds,data){
 					var deferred = Q.defer();
 					ds.logger('start calculation on distributed system');
 					
 					deferred.resolve();
 					
 					return deferred.promise;
 					
 				},
 				sharedData: function(ds,data){
 					ds.logger('shared data received from master');
 				},
 				sharedDataOnMaster: function(ds,data){
 					ds.logger('shared data received from slave, redistributing to slaves');
 				},
 				jobPartEnd: function(ds){
 					ds.logger('slave finished');
 				},
 				jobEnd: function(ds){
 					ds.logger('job finished');
 					
 					var end = window.performance.now();
 					var time = end - start;
 					
 					log_callback(max-count,time);
 					console.log(max-count);
 					if( count > 1 ){
 						count--;
 						window.setTimeout(function(){ communciationOtherClient(); },1);
 					}
 				},
 				slaveAcquired: function(ds,data){
 					ds.logger('slave acquired '+data.sender_id);
 				}
 				
 				
 			});
 			
 			
 			distributedSystem.addJob( 'roundtrip_message',{
 					initMaster: function(ds){
 						ds.logger = function(txt,replace){
 							if( replace ){
 								document.getElementById('log_distributed').innerHTML=txt+'<br/>';
 							} else {
 								document.getElementById('log_distributed').innerHTML=txt+'<br/>'+document.getElementById('log_distributed').innerHTML;
 							}
 						};
 						//ds.logger('');
 						
 					},
 					initSlave: function(ds){
 						ds.logger = function(txt,replace){
 							if( replace ){
 								document.getElementById('log_distributed').innerHTML=txt+'<br/>';
 							} else {
 								document.getElementById('log_distributed').innerHTML+=txt+'<br/>';
 							}
 						};
 						ds.logger('<br/>new job');
 						ds.results = Array();
 						//holds the mesured times:
 						
 					},
 					unavailable: function(ds){
 						$('#results').after('distributed system not available');
 						$('#results').remove();
 					},
 					
 					start: function(ds,data){
 						ds.deferred = Q.defer();
 						ds.logger('start calculation on distributed system');
 						
 						ds.count = parseInt(data.count);
 						console.log(ds.count);
 						ds.fnct = function(){
 							this.deferred.notify({start: window.performance.now()});
 						};
 						window.setTimeout(function(){ds.fnct();}, 100 );
 						
 						return ds.deferred.promise;
 						
 					},
 					sharedData: function(ds,data){
 						ds.logger('shared data received from master');
 						
 						ds.results.push(window.performance.now()-data.start);
 						
 						if( ds.count > 1 ){
 							ds.count--;
 							//repeat measurement until requested number is reached
 							window.setTimeout(function(){ds.fnct();}, 5000 );
 						} else {
 							ds.deferred.resolve(ds.results);
 						}
 					},
 					sharedDataOnMaster: function(ds,data){
 						ds.logger('shared data received from slave, redistributing to slaves');
 					},
 					jobPartEnd: function(ds){
 						ds.logger('slave finished');
 					},
 					jobEnd: function(ds,data){
 						ds.logger('job finished');
 						log_callback_all(data.result);
 					},
 					slaveAcquired: function(ds,data){
 						ds.logger('slave acquired '+data.sender_id);
 					}
 					
 					
 				});
 			
 			
 			
 			return distributedSystem;
 		};
 		distributedSystemInit();
 		
 		function startCommunicationJobBenchmark(){
 			max = parseInt(document.getElementById('counts').value);
 			count = max;
 			communciationOtherClient();
 		};
 		
 		
 		function communciationOtherClient(){
			start = window.performance.now();
			//only require 1 client to measure roundtrip time:
			distributedSystem.startJob(1,'roundtrip',{});
		};
 		
 		
 		function startCommunicationBenchmark(){
 			var x = parseInt(document.getElementById('counts').value);
 			if( isNaN(x) ) x = 1;
 			console.log(x);
 			var data = {};
 			data.count = x;
 			distributedSystem.startJob(1,'roundtrip_message',[data]);
 		}
 		
 		
 		
 		
 		var is_object = function(someVar){
 			return (Object.prototype.toString.call( someVar ) === '[object Object]');
 		};
 		
 		
 		var table = document.getElementById('results');
 		var log_callback = function(j,time){
 			// Create an empty <tr> element and add it to the 1st position of the table:
 			var row = table.insertRow(j);
 			
 			// Insert new cells (<td> elements) at the 1st and 2nd position of the "new" <tr> element:
 			//var cell1 = row.insertCell(0);
 			var cell2 = row.insertCell(0);
 			
 			// Add some text to the new cells:
 			//cell1.innerHTML = j+1;
 			cell2.innerHTML = time;
 		
 		};
 		
 		var log_callback_all = function(r){
 			for( var i in r ){
 				log_callback(i,r[i]);
 			}
 		};
 		
 	</script>
 	
</body>
 
</html>